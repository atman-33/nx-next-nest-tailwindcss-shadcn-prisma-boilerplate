# graphql-codegen をセットアップ

## 参考URL

<https://zenn.dev/layerx/articles/028cb518cffd61> 
<https://nhost.io/blog/how-to-use-graphql-code-generator-with-react-and-apollo>
<https://zenn.dev/optimisuke/articles/8de632308cebeb>
<https://zenn.dev/sky/articles/47b86d3387389d>
<https://zenn.dev/buyselltech/articles/b64935ea7d6fee>

## ステップ

### 1. data-access-graphql プロジェクトを生成

```bash
npx nx generate @nx/js:library data-access-graphql --directory=libs/web/data-access-graphql --importPath=@libs/web/data-access-graphql --tags=scope:web --bundler=swc

✔ Which unit test runner would you like to use? · none
```

### 2. パッケージをインストール

```bash
npm i -D typescript ts-node @graphql-codegen/cli @graphql-codegen/client-preset

npm i graphql-request
```

watch モードを利用する場合は、下記もインストール

```bash
npm i -D @parcel/watcher
```

### 3. codegen.yml を作成

`tools/graphql-codegen/codegen.ts`

```ts
import type { CodegenConfig } from '@graphql-codegen/cli';

const codegenConfig: CodegenConfig = {
  overwrite: true,
  schema: 'dist/apps/api/autogenerated-schema.gql',
  documents: ['apps/web/**/*.graphql', 'libs/**/*.graphql'],
  generates: {
    'libs/web/data-access-graphql/src/lib/__generated__/': {
      preset: 'client',
      plugins: [
        {
          // branded type for custom Scalar
          add: {
            content: `export type DateString = string & { readonly __brand: unique symbol }`
          }
        }
      ],
      config: {
        strictScalars: true,
        useTypeImports: true,
        skipTypename: true,
        arrayInputCoercion: true,
        avoidOptionals: {
          field: true,
          inputValue: false,
          object: true,
          defaultValue: false
        },
        scalars: {
          DateTime: 'Date',
          Date: 'Date'
        },
        enumsAsTypes: true
      }
    }
  }
};

export default codegenConfig;
```

### 4. graphqlコードを準備

e.g. `libs/web/data-access-graphql/src/lib/sample.graphql`

```graphql
query getDummies {
  dummies {
    id
    text
    createdAt
    updatedAt
  }
}
```

> config 設定により、web/libs内の`.graphql`ファイルからコードを自動生成する。

### 5. コード生成用のスクリプトを追加

`package.json`

```json
"scripts": {
    ...,
    "----START----": "-------------------------",
    "start:gql:watch": "graphql-codegen --config tools/graphql-codegen/codegen.ts --watch",
    ...,
```

スクリプト実行により、コードを自動生成する。

```bash
npm run start:gql:watch
```

### 6. data-access-graphql の index.ts を修正

`libs/web/data-access-graphql/src/index.ts`

```ts
export * from './lib/__generated__';
```